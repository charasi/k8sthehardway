---
- name: Add RBAC for scheduler, controller-manager, and reverse
  hosts: k8controller1
  remote_user: wisccourant
  become: true

  tasks:
    - name: Provision the Kubernetes Control Plane
      block:
        - name: Set correct permissions for kubeconfig admin
          ansible.builtin.command:
            cmd: sudo chmod 644 /var/lib/kubernetes/admin.kubeconfig
          register: chmod_status
          changed_when: true

        - name: Create custom ClusterRole for admin
          ansible.builtin.shell: |
            set -o pipefail
            export KUBECONFIG=/var/lib/kubernetes/admin.kubeconfig
            cat <<EOF | kubectl apply -f -
            apiVersion: rbac.authorization.k8s.io/v1
            kind: ClusterRole
            metadata:
              annotations:
                rbac.authorization.kubernetes.io/autoupdate: "true"
              labels:
                kubernetes.io/bootstrapping: rbac-defaults
              name: system:kube-apiserver-to-kubelet
            rules:
              - apiGroups:
                  - ""
                resources:
                  - nodes/proxy
                  - nodes/stats
                  - nodes/log
                  - nodes/spec
                  - nodes/metrics
                verbs:
                  - "*"
            EOF
          register: rbac_status
          changed_when: false
          args:
            executable: /bin/bash

        - name: Bind custom ClusterRole to admin
          ansible.builtin.shell: |
            set -o pipefail
            export KUBECONFIG=/var/lib/kubernetes/admin.kubeconfig
            cat <<EOF | kubectl apply -f -
            apiVersion: rbac.authorization.k8s.io/v1
            kind: ClusterRoleBinding
            metadata:
              name: system:kube-apiserver
            roleRef:
              apiGroup: rbac.authorization.k8s.io
              kind: ClusterRole
              name: system:kube-apiserver-to-kubelet
            subjects:
              - kind: User
                name: kubernetes
                apiGroup: rbac.authorization.k8s.io
            EOF
          register: rbac_binding_status
          changed_when: false
          args:
            executable: /bin/bash

        - name: Create custom ClusterRole for controller-manager
          ansible.builtin.shell: |
            set -o pipefail
            export KUBECONFIG=/var/lib/kubernetes/admin.kubeconfig
            cat <<EOF | kubectl apply -f -
            apiVersion: rbac.authorization.k8s.io/v1
            kind: ClusterRole
            metadata:
              name: system:kube-controller-manager
            rules:
              - apiGroups: [""]
                resources: ["*"]
                verbs: ["*"]
          
              - apiGroups: ["apps"]
                resources: ["*"]
                verbs: ["*"]
          
              - apiGroups: ["batch"]
                resources: ["*"]
                verbs: ["*"]
          
              - apiGroups: ["autoscaling"]
                resources: ["*"]
                verbs: ["*"]
          
              - apiGroups: ["networking.k8s.io"]
                resources: ["*"]
                verbs: ["*"]
          
              - apiGroups: ["coordination.k8s.io"]
                resources: ["*"]
                verbs: ["*"]
          
              - apiGroups: ["storage.k8s.io"]
                resources: ["*"]
                verbs: ["*"]
          
              - apiGroups: ["discovery.k8s.io"]
                resources: ["*"]
                verbs: ["*"]
          
              - apiGroups: ["scheduling.k8s.io"]
                resources: ["*"]
                verbs: ["*"]
          
              - apiGroups: ["resource.k8s.io"]
                resources: ["*"]
                verbs: ["*"]
          
              - apiGroups: ["internal.apiserver.k8s.io"]
                resources: ["*"]
                verbs: ["*"]
          
              - apiGroups: ["admissionregistration.k8s.io"]
                resources: ["validatingadmissionpolicies", "validatingadmissionpolicybindings"]
                verbs: ["*"]
          
              - apiGroups: ["node.k8s.io"]
                resources: ["runtimeclasses"]
                verbs: ["*"]
          
              - apiGroups: ["flowcontrol.apiserver.k8s.io"]
                resources: ["flowschemas"]
                verbs: ["*"]
          
              - apiGroups: ["rbac.authorization.k8s.io"]
                resources: ["rolebindings", "roles", "clusterroles"]
                verbs: ["*"]
             EOF
          register: rbac_status
          changed_when: false
          args:
            executable: /bin/bash

        - name: Bind custom ClusterRole to controller-manager
          ansible.builtin.shell: |
            set -o pipefail
            export KUBECONFIG=/var/lib/kubernetes/admin.kubeconfig
            cat <<EOF | kubectl apply -f -
            apiVersion: rbac.authorization.k8s.io/v1
            kind: ClusterRoleBinding
            metadata:
              name: system:controller-manager-leases
            subjects:
              - kind: User
                name: system:controller-manager
                apiGroup: rbac.authorization.k8s.io
            roleRef:
              kind: ClusterRole
              name: system:kube-controller-manager
              apiGroup: rbac.authorization.k8s.io
            EOF
          register: rbac_binding_status
          changed_when: false
          args:
            executable: /bin/bash
